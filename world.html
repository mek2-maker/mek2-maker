<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>인터랙티브 3D 지구본 (Three.js 버전)</title>
  <script type="importmap">
  {
    "imports": {
      "three": "./libs/three.module.js"
    }
  }
  </script>
  <style>
    body { margin: 0; overflow: hidden; }
    #overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
      background: rgba(255, 255, 255, 0.8);
      padding: 10px;
      border-radius: 5px;
      font-family: sans-serif;
    }
  </style>
</head>
<body>
  <!-- 사용자 인터페이스 -->
  <div id="overlay">
    <label for="iso-code">ISO_A3 코드 입력 (예: USA, CHN, KOR):</label>
    <input type="text" id="iso-code" placeholder="Enter Country Code">
    <button id="submit-btn">국가 선택</button>
  </div>

  <script type="module">
    import * as THREE from "./libs/three.module.js";
    import { OrbitControls } from "./libs/OrbitControls.js";
    import TWEEN from "./libs/tween.esm.js";

    let scene, camera, renderer, controls;
    let globeMesh, boundaryLine, koreaBoundary;
    let countryGeoJSON = null;
    const globeRadius = 1;

    // 위도/경도를 3D 좌표로 변환 (지구본 좌표계)
    function latLonToXYZ(lat, lon, radius = globeRadius) {
      const phi = (90 - lat) * (Math.PI / 180);
      const theta = (lon + 180) * (Math.PI / 180);
      const x = -radius * Math.sin(phi) * Math.cos(theta);
      const z = radius * Math.sin(phi) * Math.sin(theta);
      const y = radius * Math.cos(phi);
      return new THREE.Vector3(x, y, z);
    }

    function init() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      // OrbitControls 생성
      controls = new OrbitControls(camera, renderer.domElement);
      camera.position.set(2, 2, 2);
      controls.update();

      // 지구본 생성: 텍스처 적용
      const sphereGeometry = new THREE.SphereGeometry(globeRadius, 64, 64);
      const textureLoader = new THREE.TextureLoader();
      const texture = textureLoader.load('eo_base_2020_clean_geo.jpg');
      const sphereMaterial = new THREE.MeshBasicMaterial({ map: texture });
      globeMesh = new THREE.Mesh(sphereGeometry, sphereMaterial);
      scene.add(globeMesh);

      // GeoJSON 파일 로드 (국가 경계선)
      fetch('countries.geojson')
        .then(response => response.json())
        .then(data => {
          countryGeoJSON = data;
          drawKoreaBoundary(); // 대한민국 기본 표시
        })
        .catch(err => console.error('GeoJSON 로드 실패:', err));

      animate();
    }

    function drawKoreaBoundary() {
      if (!countryGeoJSON) return;

      let feature = countryGeoJSON.features.find(f => f.properties.ISO_A3 === "KOR");
      if (!feature) return;

      let coordinates = feature.geometry.type === "Polygon" ? feature.geometry.coordinates[0] : feature.geometry.coordinates[0][0];
      let points = coordinates.map(coord => latLonToXYZ(coord[1], coord[0], globeRadius + 0.005));

      if (!points[0].equals(points[points.length - 1])) {
        points.push(points[0]);
      }

      const geometry = new THREE.BufferGeometry().setFromPoints(points);
      const material = new THREE.LineBasicMaterial({ color: 0x0000ff }); // 대한민국은 파란색
      koreaBoundary = new THREE.Line(geometry, material);
      scene.add(koreaBoundary);
    }

    function updateCountryGlobe() {
      const isoCode = document.getElementById('iso-code').value.trim().toUpperCase();
      if (!isoCode) return;

      // 기존 경계선 제거
      if (boundaryLine) {
        scene.remove(boundaryLine);
        boundaryLine.geometry.dispose();
        boundaryLine.material.dispose();
        boundaryLine = null;
      }

      if (!countryGeoJSON) {
        alert("GeoJSON 데이터가 아직 로드되지 않았습니다.");
        return;
      }

      // 선택한 국가 찾기
      let feature = countryGeoJSON.features.find(f => f.properties.ISO_A3 === isoCode);
      if (!feature) {
        alert("해당 국가 경계 데이터를 찾을 수 없습니다: " + isoCode);
        return;
      }

      // Polygon 또는 MultiPolygon 처리
      let coordinates = feature.geometry.type === "Polygon" ? feature.geometry.coordinates[0] : feature.geometry.coordinates[0][0];
      let points = coordinates.map(coord => latLonToXYZ(coord[1], coord[0], globeRadius + 0.005));

      if (!points[0].equals(points[points.length - 1])) {
        points.push(points[0]);
      }

      // 대한민국(KOR)은 파란색, 그 외는 빨간색
      const lineColor = isoCode === "KOR" ? 0x0000ff : 0xff0000;
      const geometry = new THREE.BufferGeometry().setFromPoints(points);
      const material = new THREE.LineBasicMaterial({ color: lineColor });
      boundaryLine = new THREE.Line(geometry, material);
      scene.add(boundaryLine);

      // 카메라 이동 (너무 가까이 가지 않도록 2.2배 거리 유지)
      const center = new THREE.Vector3();
      points.forEach(p => center.add(p));
      center.divideScalar(points.length);

      const newCameraPos = center.clone().multiplyScalar(2.2);

      new TWEEN.Tween(camera.position)
        .to({ x: newCameraPos.x, y: newCameraPos.y, z: newCameraPos.z }, 1000)
        .easing(TWEEN.Easing.Quadratic.Out)
        .onComplete(() => {
          controls.target.copy(center);
        })
        .start();
    }

    function animate(time) {
      requestAnimationFrame(animate);
      TWEEN.update(time);
      controls.update();
      renderer.render(scene, camera);
    }

    document.getElementById('submit-btn').addEventListener('click', updateCountryGlobe);
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    window.onload = init;
  </script>
</body>
</html>
